<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Move - Final Fix</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
    
    <style>
        body { font-family: 'Kanit', sans-serif; text-align: center; background: #f0f7f4; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); display: inline-block; width: 100%; max-width: 450px; }
        h1 { color: #2ecc71; margin-bottom: 10px; }
        #canvas-container { position: relative; width: 300px; height: 300px; margin: 15px auto; border: 5px solid #2ecc71; border-radius: 15px; background: #000; }
        .counter { font-size: 4.5rem; font-weight: bold; color: #2c3e50; margin: 10px 0; }
        .status-bar { background: #f8f9fa; padding: 12px; border-radius: 12px; margin-bottom: 15px; }
        button { background: #2ecc71; color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.2rem; cursor: pointer; transition: 0.3s; }
        button:hover { background: #27ae60; }
    </style>
</head>
<body>

    <div class="card">
        <h1>üèÉ‚Äç‚ôÇÔ∏è Happy Move</h1>
        <p>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≠ (neck) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>

        <div id="canvas-container">
            <canvas id="canvas"></canvas>
        </div>

        <div class="counter">
            <span id="count-number">0</span><span style="font-size: 1.5rem; color: #ccc;"> / 5</span>
        </div>

        <div class="status-bar">
            <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="status-text" style="color: #2ecc71; font-weight: bold;">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°...</span></div>
            <div style="font-size: 0.8rem; color: #95a5a6;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô: <span id="confidence-text">0%</span></div>
        </div>

        <button id="start-btn" onclick="init()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
    </div>

    <script>
        // URL ‡∏à‡∏≤‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡∏£‡∏ô (neck / nomal)
        const URL = "https://teachablemachine.withgoogle.com/models/fpJDHbtga/";
        let model, webcam, ctx, labelContainer, maxPredictions;
        let count = 0;
        let lastClass = "";
        let isRunning = false;

        async function init() {
            const btn = document.getElementById("start-btn");
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...";
            btn.disabled = true;

            try {
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";

                // 1. ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• Pose
                model = await tmPose.load(modelURL, metadataURL);
                
                // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á
                const size = 300;
                const flip = true; 
                webcam = new tmPose.Webcam(size, size, flip);
                await webcam.setup(); 
                await webcam.play();
                
                // 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Canvas ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å
                const canvas = document.getElementById("canvas");
                canvas.width = size; canvas.height = size;
                ctx = canvas.getContext("2d");

                btn.style.display = "none";
                isRunning = true;
                window.requestAnimationFrame(loop);
                
            } catch (e) {
                console.error(e);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤: " + e.message);
                btn.innerText = "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
                btn.disabled = false;
            }
        }

        async function loop(timestamp) {
            if (isRunning) {
                webcam.update(); 
                await predict();
                window.requestAnimationFrame(loop);
            }
        }

        async function predict() {
            // ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á
            const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
            const prediction = await model.predict(posenetOutput);

            // ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ö‡∏ô Canvas
            ctx.drawImage(webcam.canvas, 0, 0);

            // ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡πâ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å (‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà)
            if (pose) {
                tmPose.drawKeypoints(pose.keypoints, 0.8, ctx);
                tmPose.drawSkeleton(pose.keypoints, 0.8, ctx);
            }

            // ‡∏´‡∏≤ Class ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
            let bestClass = "";
            let highestProb = 0;
            for (let i = 0; i < prediction.length; i++) {
                if (prediction[i].probability > highestProb) {
                    highestProb = prediction[i].probability;
                    bestClass = prediction[i].className;
                }
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
            document.getElementById("status-text").innerText = bestClass;
            document.getElementById("confidence-text").innerText = (highestProb * 100).toFixed(0) + "%";

            // ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ neck ‡πÅ‡∏•‡∏∞ nomal ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ)
            if (highestProb > 0.85) { // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ 85% ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
                if (lastClass !== bestClass) {
                    // ‡∏ñ‡πâ‡∏≤‡∏ô‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (nomal) ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡πà‡∏≤‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≠ (neck)
                    if (bestClass === "neck") { 
                        count++;
                        document.getElementById("count-number").innerText = count;

                        if (count >= 5) {
                            isRunning = false;
                            setTimeout(() => {
                                alert("üéâ ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Ñ‡∏≠ (neck) ‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß");
                                resetCount();
                            }, 100);
                        }
                    }
                    lastClass = bestClass;
                }
            }
        }

        function resetCount() {
            count = 0;
            lastClass = "";
            document.getElementById("count-number").innerText = "0";
            isRunning = true;
            window.requestAnimationFrame(loop);
        }
    </script>
</body>
</html>